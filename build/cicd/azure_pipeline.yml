# Variable 'PI_LOCAL_CADENCE' was defined in the Variables tab
# Variable Group 'Cadence Variables' was defined in the Variables tab
# Agent Queue 'Azure Pipelines' was used with unrecognized Agent Specification, vmImage property must be specified to determine image - https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=yaml#software
name: $(PI_LIBRARY_MAJORVERSION).$(PI_LIBRARY_MINORVERSION).$(PI_LIBRARY_BUILDVERSION)-$(PI_LOCAL_CADENCE).$(Date:yyMMdd)$(Rev:rr)
resources:
  repositories:
  - repository: self
    type: git
    ref: main
  - repository: protocols
    type: git
    ref: main
jobs:
- job: Job_1
  displayName: Hosted Windows
  pool:
    name: Azure Pipelines
  steps:
  - checkout: self
    clean: true
  - task: UseDotNet@2
    displayName: Use .NET Core
    inputs:
      useGlobalJson: true
  - task: PowerShell@2
    displayName: Set Pipeline Cadence
    inputs:
      targetType: inline
      script: >-
        # See https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=classic%2Cbatch for variable expansion

        # Set the PI_LIBRARY_CADENCE to either preview, rc or release. This variable is used in downstream *.csproj to restore the NuGet references.

        # PI_TASKGROUP_CADENCE is passed by the parent pipeline


        Write-Host "##vso[task.setvariable variable=PI_LIBRARY_CADENCE]$(PI_LOCAL_CADENCE)"
      failOnStderr: true
  - task: PowerShell@2
    displayName: Set Package Version (preview)
    condition: eq(variables.PI_LIBRARY_CADENCE, 'preview')
    inputs:
      targetType: inline
      script: >-
        # preview or rc

        # Set the PI_LIBRARY_PACKAGEVERSION to the BUILD_BUILDNUMBER e.g. 2.3.2-preview.251236

        # BUILD_BUILDNUMBER is expected to be set in the Parent pipeline

        Write-Host "##vso[task.setvariable variable=PI_LIBRARY_PACKAGEVERSION]$env:BUILD_BUILDNUMBER"
      failOnStderr: true
  - task: PowerShell@2
    displayName: 'Set Package Version (rc) '
    condition: eq(variables.PI_LIBRARY_CADENCE, 'rc')
    inputs:
      targetType: inline
      script: >-
        # preview or rc

        # Set the PI_LIBRARY_PACKAGEVERSION to the BUILD_BUILDNUMBER e.g. 2.3.2-preview.251236

        # BUILD_BUILDNUMBER is expected to be set in the Parent pipeline

        Write-Host "##vso[task.setvariable variable=PI_LIBRARY_PACKAGEVERSION]$env:BUILD_BUILDNUMBER"
      failOnStderr: true
  - task: PowerShell@2
    displayName: 'Set Package Version (release) '
    condition: eq(variables.PI_LIBRARY_CADENCE, 'release')
    inputs:
      targetType: inline
      script: >-
        # release will just use the Major.Minor.Build sematic versions

        Write-Host "##vso[task.setvariable variable=PI_LIBRARY_PACKAGEVERSION]$env:PI_LIBRARY_MAJORVERSION.$env:PI_LIBRARY_MINORVERSION.$env:PI_LIBRARY_BUILDVERSION"
      failOnStderr: true
  - task: PowerShell@2
    displayName: Print Pipeline Cadence
    inputs:
      targetType: inline
      script: >-
        Write-Host Build number: $env:BUILD_BUILDNUMBER

        Write-Host  Major version: $env:PI_LIBRARY_MAJORVERSION

        Write-Host  Minor version: $env:PI_LIBRARY_MINORVERSION

        Write-Host  Build version: $env:PI_LIBRARY_BUILDVERSION


        Write-Host Task-group pipeline cadence: $(PI_LOCAL_CADENCE)

        Write-Host Library cadence: $env:PI_LIBRARY_CADENCE

        Write-Host Library package version: $env:PI_LIBRARY_PACKAGEVERSION

        Write-Host Library package version environment variable name: $env:PI_LIBRARY_PACKAGEVERSION_ENVNAME
  - task: PowerShell@2
    displayName: Print Configuration
    inputs:
      targetType: inline
      script: >
        Write-Host Build Configuration: $(BuildConfiguration)

        Write-Host Project name: PerpetualIntelligence.Shared

        Write-Host Package folder: $(Build.ArtifactStagingDirectory)

        Write-Host Package version: $env:PI_LIBRARY_PACKAGEVERSION
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: >-
        **/src/PerpetualIntelligence.Shared/PerpetualIntelligence.Shared.csproj

        **/test/PerpetualIntelligence.Shared.Test/PerpetualIntelligence.Shared.Test.csproj
      zipAfterPublish: false
      selectOrConfig: config
      nugetConfigPath: $(Build.SourcesDirectory)/build/config/nuget.config
      verbosityRestore: Minimal
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/src/PerpetualIntelligence.Shared/PerpetualIntelligence.Shared.csproj'
      arguments: --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/test/PerpetualIntelligence.Shared.Test/PerpetualIntelligence.Shared.Test.csproj'
      arguments: --configuration $(BuildConfiguration) --logger trx
  - task: DotNetCoreCLI@2
    displayName: Pack
    inputs:
      command: pack
      searchPatternPack: '**/src/PerpetualIntelligence.Shared/PerpetualIntelligence.Shared.csproj'
      nobuild: true
      versioningScheme: byEnvVar
      versionEnvVar: PI_LIBRARY_PACKAGEVERSION
      verbosityPack: Minimal
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path $(Build.ArtifactStagingDirectory)
  - task: DotNetCoreCLI@2
    displayName: Push
    inputs:
      command: push
      searchPatternPush: $(Build.ArtifactStagingDirectory)/PerpetualIntelligence.Shared*.nupkg
      feedPublish: ccddf6d3-d216-4bc2-80cf-2725ac15f819/225e33e8-c1db-4d60-962b-649dcd7f4c89
  - task: PowerShell@2
    displayName: Print Configuration
    inputs:
      targetType: inline
      script: >
        Write-Host Build Configuration: $(BuildConfiguration)

        Write-Host Project name: PerpetualIntelligence.Test

        Write-Host Package folder: $(Build.ArtifactStagingDirectory)

        Write-Host Package version: $env:PI_LIBRARY_PACKAGEVERSION
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: >-
        **/src/PerpetualIntelligence.Test/PerpetualIntelligence.Test.csproj

        **/test/PerpetualIntelligence.Test.Test/PerpetualIntelligence.Test.Test.csproj
      zipAfterPublish: false
      selectOrConfig: config
      nugetConfigPath: $(Build.SourcesDirectory)/build/config/nuget.config
      verbosityRestore: Minimal
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/src/PerpetualIntelligence.Test/PerpetualIntelligence.Test.csproj'
      arguments: --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/test/PerpetualIntelligence.Test.Test/PerpetualIntelligence.Test.Test.csproj'
      arguments: --configuration $(BuildConfiguration) --logger trx
  - task: DotNetCoreCLI@2
    displayName: Pack
    inputs:
      command: pack
      searchPatternPack: '**/src/PerpetualIntelligence.Test/PerpetualIntelligence.Test.csproj'
      nobuild: true
      versioningScheme: byEnvVar
      versionEnvVar: PI_LIBRARY_PACKAGEVERSION
      verbosityPack: Minimal
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path $(Build.ArtifactStagingDirectory)
  - task: DotNetCoreCLI@2
    displayName: Push
    inputs:
      command: push
      searchPatternPush: $(Build.ArtifactStagingDirectory)/PerpetualIntelligence.Test*.nupkg
      feedPublish: ccddf6d3-d216-4bc2-80cf-2725ac15f819/225e33e8-c1db-4d60-962b-649dcd7f4c89
  - task: PowerShell@2
    displayName: Print Configuration
    inputs:
      targetType: inline
      script: >
        Write-Host Build Configuration: $(BuildConfiguration)

        Write-Host Project name: PerpetualIntelligence.Protocols

        Write-Host Package folder: $(Build.ArtifactStagingDirectory)

        Write-Host Package version: $env:PI_LIBRARY_PACKAGEVERSION
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: >-
        **/src/PerpetualIntelligence.Protocols/PerpetualIntelligence.Protocols.csproj

        **/test/PerpetualIntelligence.Protocols.Test/PerpetualIntelligence.Protocols.Test.csproj
      zipAfterPublish: false
      selectOrConfig: config
      nugetConfigPath: $(Build.SourcesDirectory)/build/config/nuget.config
      verbosityRestore: Minimal
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/src/PerpetualIntelligence.Protocols/PerpetualIntelligence.Protocols.csproj'
      arguments: --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/test/PerpetualIntelligence.Protocols.Test/PerpetualIntelligence.Protocols.Test.csproj'
      arguments: --configuration $(BuildConfiguration) --logger trx
  - task: DotNetCoreCLI@2
    displayName: Pack
    inputs:
      command: pack
      searchPatternPack: '**/src/PerpetualIntelligence.Protocols/PerpetualIntelligence.Protocols.csproj'
      nobuild: true
      versioningScheme: byEnvVar
      versionEnvVar: PI_LIBRARY_PACKAGEVERSION
      verbosityPack: Minimal
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path $(Build.ArtifactStagingDirectory)
  - task: DotNetCoreCLI@2
    displayName: Push
    inputs:
      command: push
      searchPatternPush: $(Build.ArtifactStagingDirectory)/PerpetualIntelligence.Protocols*.nupkg
      feedPublish: ccddf6d3-d216-4bc2-80cf-2725ac15f819/225e33e8-c1db-4d60-962b-649dcd7f4c89
  - task: PowerShell@2
    displayName: Print Configuration
    inputs:
      targetType: inline
      script: >
        Write-Host Build Configuration: $(BuildConfiguration)

        Write-Host Project name: PerpetualIntelligence.Protocols.Defaults

        Write-Host Package folder: $(Build.ArtifactStagingDirectory)

        Write-Host Package version: $env:PI_LIBRARY_PACKAGEVERSION
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: >-
        **/src/PerpetualIntelligence.Protocols.Defaults/PerpetualIntelligence.Protocols.Defaults.csproj

        **/test/PerpetualIntelligence.Protocols.Defaults.Test/PerpetualIntelligence.Protocols.Defaults.Test.csproj
      zipAfterPublish: false
      selectOrConfig: config
      nugetConfigPath: $(Build.SourcesDirectory)/build/config/nuget.config
      verbosityRestore: Minimal
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: '**/src/PerpetualIntelligence.Protocols.Defaults/PerpetualIntelligence.Protocols.Defaults.csproj'
      arguments: --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/test/PerpetualIntelligence.Protocols.Defaults.Test/PerpetualIntelligence.Protocols.Defaults.Test.csproj'
      arguments: --configuration $(BuildConfiguration) --logger trx
  - task: DotNetCoreCLI@2
    displayName: Pack
    inputs:
      command: pack
      searchPatternPack: '**/src/PerpetualIntelligence.Protocols.Defaults/PerpetualIntelligence.Protocols.Defaults.csproj'
      nobuild: true
      versioningScheme: byEnvVar
      versionEnvVar: PI_LIBRARY_PACKAGEVERSION
      verbosityPack: Minimal
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path $(Build.ArtifactStagingDirectory)
  - task: DotNetCoreCLI@2
    displayName: Push
    inputs:
      command: push
      searchPatternPush: $(Build.ArtifactStagingDirectory)/PerpetualIntelligence.Protocols.Defaults*.nupkg
      feedPublish: ccddf6d3-d216-4bc2-80cf-2725ac15f819/225e33e8-c1db-4d60-962b-649dcd7f4c89
  - task: PublishPipelineArtifact@1
    displayName: Publish Pipeline Artifact
    inputs:
      artifactName: drop
...

