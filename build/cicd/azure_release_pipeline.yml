#    Copyright 2021 Perpetual Intelligence L.L.C. All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0.
#    https://github.com/perpetualintelligence/terms/blob/main/LICENSE
#
#    Additional terms and policies.
#    https://github.com/perpetualintelligence/terms/blob/main/policies.md

# This is the Azure pipeline yml configuration file to build and publish the documentation site.
# The pipeline uses Nuget to install the docfx tool and then builds the docfx_project. 

# Pipeline name e.g. 2.3.5-rc.21122505
name: $(PI_LIBRARY_MAJORVERSION).$(PI_LIBRARY_MINORVERSION).$(PI_LIBRARY_BUILDVERSION)-docs.$(Date:yyMMdd)$(Rev:rr)

trigger:
- main

# Provide access to cadence variables.
variables:
- group: CadenceVariables

# Build jobs
jobs:
- job: Windows
  displayName: Hosted Windows

  pool:
    vmImage: windows-latest
    name: Azure Pipelines

  steps:

  # Download the latest build artifact
  - task: DownloadPipelineArtifact@2
    displayName: Download Site (latest cadence)
    inputs:
      buildType: 'specific'
      project: 'ccddf6d3-d216-4bc2-80cf-2725ac15f819'
      definition: '55'
      buildVersionToDownload: 'latest'
      targetPath: '$(Pipeline.Workspace)'

  # Extract the site .zip files
  - task: ExtractFiles@1
    inputs:
      archiveFilePatterns: '$(Pipeline.Workspace)/drop/PerpetualIntelligence.Docs.Site*.zip'
      destinationFolder: '$(Pipeline.Workspace)/drop/PerpetualIntelligence.Docs.Site'
      cleanDestinationFolder: true
      overwriteExistingFiles: true  

  # Dump dir
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path $(Pipeline.Workspace) -Recurse
    enabled : false
  
  # Install Node.js
  - task: NodeTool@0
    displayName: Install Node.js
    inputs:
      versionSpec: '17.x'
  
  

  - script: |
      git config user.email $(PI_LOCAL_USERNAME)
      npm install
      npm run deploy -- -r https://$(PI_LIBRARY_GITHUB_DOCS_PAT)@github.com/

...

