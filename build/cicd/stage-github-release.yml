#    Copyright 2021 Perpetual Intelligence L.L.C. All Rights Reserved.
#
#    Licensed under the Apache License, Version 2.0.
#    https://github.com/perpetualintelligence/terms/blob/main/LICENSE
#
#    Additional terms and policies.
#    https://github.com/perpetualintelligence/terms/blob/main/policies.md

# This is the Azure pipeline yml configuration file to build and publish the documentation site.
# The pipeline uses Nuget to install the docfx tool and then builds the docfx_project. 

# Pipeline name e.g. 2.3.5-docs.21122505
name: $(PI_LIBRARY_MAJORVERSION).$(PI_LIBRARY_MINORVERSION).$(PI_LIBRARY_BUILDVERSION).$(Date:yyMMdd)$(Rev:rr)

# NO CI Trigger, Manual release.
trigger: none

# Provide access to cadence variables.
variables:
- group: CadenceVariables

# Build jobs
jobs:
- job: Windows
  displayName: Hosted Windows

  pool:
    vmImage: windows-latest
    name: Azure Pipelines

  # https://docs.microsoft.com/en-us/azure/devops/pipelines/scripts/git-commands?view=azure-devops&tabs=yaml#allow-scripts-to-access-the-system-token
  # Make sure we allow scripts to access the system token, otherwise scripts cannot execute git push
  # Make sure to clean up the local repo
  # Certain kinds of changes to the local repository are not automatically cleaned up by the build pipeline. So make sure to:
  #   Delete local branches you create.
  #   Undo git config changes.
  # If you run into problems using an on-premises agent, make sure the repo is clean:  
  steps:
  - checkout: self
    persistCredentials: true
    clean: true

  # Download the latest docfx_project build artifact
  # For us this is the drop/<artifact>
  - task: DownloadPipelineArtifact@2
    displayName: Download artifact
    inputs:
      buildType: 'specific'
      project: '$(PI_BUILD_PROJECT_ID)'
      definition: '$(PI_BUILD_DEFINITION)'
      buildVersionToDownload: 'latest'
      targetPath: '$(Pipeline.Workspace)'

  # We are creating github release which already has version id, so we remove the version suffix from the artifact.
  # This helps us to find and donwload the GitHub release asset later.
  # E.g. Format: PerpetualIntelligence.Docs.Site.2.3.5-rc.2512252569 -> PerpetualIntelligence.Docs.Site.zip
  # https://stackoverflow.com/questions/34614669/how-to-rename-unknown-filename-to-new-filename
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: Get-ChildItem -Path ${env:PIPELINE_WORKSPACE}/drop/PerpetualIntelligence.Docs.Site*.zip | Rename-Item -NewName {"PerpetualIntelligence.Docs.Site.zip"}       

  # Dump dir
  - task: PowerShell@2
    displayName: Enumerate
    inputs:
      targetType: inline
      script: Get-ChildItem -Path ${env:PIPELINE_WORKSPACE} -Recurse
    enabled : true
  
  #Create Github release
  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'gitoauth.perpetualintelligence.com'
      repositoryName: 'perpetualintelligence/docs'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      tag: 'v$(Build.BuildNumber)'
      title: 'v$(Build.BuildNumber)'
      releaseNotesSource: 'inline'
      releaseNotesInline: 'The documentation assets for managed services, frameworks and tools.'
      assets: '$(Pipeline.Workspace)/drop/PerpetualIntelligence.Docs.Site.zip'
      isPreRelease: true
      addChangeLog: false
...